<!-- Actualización para public/views/carrito.html - Nuevo formulario de checkout -->

<section class="hero">
    <div class="hero-content">
        <h1>Carrito de Compras</h1>
        <p>Revisa y finaliza tu compra</p>
    </div>
</section>

<section class="container">
    <div class="cart-page">
        <div class="cart-items-container">
            <h2 class="section-title">Tus productos</h2>
            
            <div id="cart-items-list">
                <!-- Aquí se mostrarán los productos del carrito -->
                <div class="empty-cart-message" style="display: none;">
                    <p>Tu carrito está vacío</p>
                    <a href="/productos" class="btn">Ver productos</a>
                </div>
            </div>
            
            <div class="cart-summary">
                <div class="cart-total">
                    <span>Total:</span>
                    <span id="cart-total-price">$0</span>
                </div>
            </div>
        </div>
        
        <div class="checkout-container">
            <h2 class="section-title">Información de contacto</h2>
            
            <form id="checkout-form">
                <div class="form-group">
                    <label for="nombres">Nombre(s) *</label>
                    <input type="text" id="nombres" name="nombres" required>
                </div>
                
                <div class="form-group">
                    <label for="apellidos">Apellidos *</label>
                    <input type="text" id="apellidos" name="apellidos" required>
                </div>
                
                <div class="form-group">
                    <label for="tipo_documento">Tipo de Documento de Identidad *</label>
                    <select id="tipo_documento" name="tipo_documento" required>
                        <option value="" disabled selected>Seleccione una opción</option>
                        <option value="CC">Cédula de Ciudadanía</option>
                        <option value="CE">Cédula de Extranjería</option>
                        <option value="TI">Tarjeta de Identidad</option>
                        <option value="PASAPORTE">Pasaporte</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="num_documento">Número de Documento de Identidad *</label>
                    <input type="text" id="num_documento" name="num_documento" required>
                </div>
                
                <div class="form-group">
                    <label for="fecha_nacimiento">Fecha de Nacimiento *</label>
                    <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" required>
                </div>
                
                <div class="form-group">
                    <label for="sexo">Sexo</label>
                    <select id="sexo" name="sexo">
                        <option value="" disabled selected>Seleccione una opción</option>
                        <option value="M">Masculino</option>
                        <option value="F">Femenino</option>
                        <option value="O">Otro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="estado_civil">Estado Civil</label>
                    <select id="estado_civil" name="estado_civil">
                        <option value="" disabled selected>Seleccione una opción</option>
                        <option value="soltero">Soltero/a</option>
                        <option value="casado">Casado/a</option>
                        <option value="union_libre">Unión Libre</option>
                        <option value="separado">Separado/a</option>
                        <option value="divorciado">Divorciado/a</option>
                        <option value="viudo">Viudo/a</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ciudad">Ciudad *</label>
                    <input type="text" id="ciudad" name="ciudad" required>
                </div>
                
                <div class="form-group">
                    <label for="direccion">Dirección de entrega *</label>
                    <input type="text" id="direccion" name="direccion" required>
                </div>
                
                <div class="form-group">
                    <label for="telefono_fijo">Teléfono Fijo</label>
                    <input type="tel" id="telefono_fijo" name="telefono_fijo">
                </div>
                
                <div class="form-group">
                    <label for="telefono_movil">Teléfono Móvil *</label>
                    <input type="tel" id="telefono_movil" name="telefono_movil" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Correo Electrónico *</label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <h3>Método de pago</h3>
                <div class="payment-methods">
                    <div class="payment-method">
                        <input type="radio" id="bancolombia" name="metodo_pago" value="Bancolombia" checked>
                        <label for="bancolombia">
                            <span class="payment-icon"><i class="fas fa-university"></i></span>
                            <span class="payment-name">Bancolombia</span>
                        </label>
                    </div>
                    
                    <div class="payment-method">
                        <input type="radio" id="nequi" name="metodo_pago" value="Nequi">
                        <label for="nequi">
                            <span class="payment-icon"><i class="fas fa-mobile-alt"></i></span>
                            <span class="payment-name">Nequi</span>
                        </label>
                    </div>
                    
                    <div class="payment-method">
                        <input type="radio" id="contraentrega" name="metodo_pago" value="Contra Entrega">
                        <label for="contraentrega">
                            <span class="payment-icon"><i class="fas fa-truck"></i></span>
                            <span class="payment-name">Pago Contra Entrega</span>
                        </label>
                    </div>
                </div>
                
                <div class="payment-details" id="payment-details-container">
                    <!-- Aquí se mostrará la información del pago según el método seleccionado -->
                </div>
                
                <div class="checkout-actions">
                    <a href="/productos" class="btn btn-secondary">Seguir comprando</a>
                    <button type="submit" class="btn" id="finalizar-compra-btn">Finalizar compra</button>
                </div>
            </form>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar carrito desde localStorage
        loadCart();
        
        // Inicializar detalles de pago
        updatePaymentDetails();
        
        // Event listeners
        document.querySelectorAll('input[name="metodo_pago"]').forEach(radio => {
            radio.addEventListener('change', updatePaymentDetails);
        });
        
        // Event listener para el formulario de checkout
        const checkoutForm = document.getElementById('checkout-form');
        if (checkoutForm) {
            checkoutForm.addEventListener('submit', function(e) {
                e.preventDefault();
                // Validar campos y enviar pedido
                enviarPedidoWhatsApp();
            });
        }
    });
    
    // Función mejorada para cargar el carrito
    function loadCart() {
        // Obtener elementos del DOM
        const cartItemsList = document.getElementById('cart-items-list');
        const emptyCartMessage = document.querySelector('.empty-cart-message');
        const cartTotalPrice = document.getElementById('cart-total-price');
        const finalizarCompraBtn = document.getElementById('finalizar-compra-btn');
        
        if (!cartItemsList || !cartTotalPrice) return;
        
        // Obtener carrito desde localStorage
        let carrito;
        try {
            carrito = JSON.parse(localStorage.getItem('carrito')) || { items: [], total: 0 };
        } catch (e) {
            carrito = { items: [], total: 0 };
            console.error('Error al parsear carrito:', e);
        }
        
        // Mostrar mensaje si el carrito está vacío
        if (carrito.items.length === 0) {
            if (emptyCartMessage) emptyCartMessage.style.display = 'block';
            if (finalizarCompraBtn) finalizarCompraBtn.disabled = true;
            cartItemsList.innerHTML = '';
            cartTotalPrice.textContent = '$0';
            return;
        }
        
        // Ocultar mensaje de carrito vacío
        if (emptyCartMessage) emptyCartMessage.style.display = 'none';
        if (finalizarCompraBtn) finalizarCompraBtn.disabled = false;
        
        // Limpiar la lista de productos
        cartItemsList.innerHTML = '';
        
        // Variables para calcular el total
        let total = 0;
        
        // Mostrar cada producto en el carrito
        carrito.items.forEach(item => {
            const subtotal = item.precio * item.cantidad;
            total += subtotal;
            
            // Crear elemento para el producto
            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.innerHTML = `
                <div class="cart-item-img">
                    <img src="${item.imagen || '/img/default-product.jpg'}" alt="${item.nombre}">
                </div>
                <div class="cart-item-details">
                    <h3>${item.nombre}</h3>
                    <p class="item-price">$${formatNumber(item.precio)}</p>
                    <div class="item-quantity">
                        <button class="quantity-btn minus" data-id="${item.id}">-</button>
                        <span>${item.cantidad}</span>
                        <button class="quantity-btn plus" data-id="${item.id}">+</button>
                    </div>
                </div>
                <div class="cart-item-subtotal">
                    <p>$${formatNumber(subtotal)}</p>
                    <button class="remove-item" data-id="${item.id}">×</button>
                </div>
            `;
            
            cartItemsList.appendChild(cartItem);
        });
        
        // Actualizar total en la interfaz
        cartTotalPrice.textContent = `$${formatNumber(total)}`;
        
        // Guardar total en el carrito
        carrito.total = total;
        localStorage.setItem('carrito', JSON.stringify(carrito));
        
        // Añadir event listeners a los botones
        addCartEventListeners();
    }

    // Función para formatear números con separadores de miles
    function formatNumber(number) {
        return number.toLocaleString('es-CO');
    }

    // Añadir event listeners a los botones del carrito
    function addCartEventListeners() {
        // Botones de incremento y decremento de cantidad
        document.querySelectorAll('.quantity-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.getAttribute('data-id');
                const isPlus = this.classList.contains('plus');
                
                // Obtener carrito
                let carrito = JSON.parse(localStorage.getItem('carrito')) || { items: [], total: 0 };
                
                // Encontrar el producto
                const productIndex = carrito.items.findIndex(item => item.id === productId);
                
                if (productIndex !== -1) {
                    if (isPlus) {
                        // Incrementar cantidad
                        carrito.items[productIndex].cantidad += 1;
                    } else {
                        // Decrementar cantidad
                        carrito.items[productIndex].cantidad -= 1;
                        
                        // Remover si la cantidad llega a 0
                        if (carrito.items[productIndex].cantidad <= 0) {
                            carrito.items.splice(productIndex, 1);
                        }
                    }
                    
                    // Guardar carrito y recargar
                    localStorage.setItem('carrito', JSON.stringify(carrito));
                    loadCart();
                }
            });
        });
        
        // Botones para eliminar productos
        document.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.getAttribute('data-id');
                
                // Obtener carrito
                let carrito = JSON.parse(localStorage.getItem('carrito')) || { items: [], total: 0 };
                
                // Filtrar el producto
                carrito.items = carrito.items.filter(item => item.id !== productId);
                
                // Guardar carrito y recargar
                localStorage.setItem('carrito', JSON.stringify(carrito));
                loadCart();
            });
        });
    }
    
    function updatePaymentDetails() {
        const container = document.getElementById('payment-details-container');
        const paymentMethod = document.querySelector('input[name="metodo_pago"]:checked').value;
        
        if (!container) return;
        
        let content = '';
        
        switch (paymentMethod) {
            case 'Bancolombia':
                content = `
                    <div class="payment-info">
                        <p><strong>Cuenta de Ahorros Bancolombia</strong></p>
                        <p>Número: 00221706692</p>
                        <p>Titular: Leidy Yohanna Montoya</p>
                        <p>NIT: 1046666351-7</p>
                        <p class="payment-note">Una vez realices la transferencia, envíanos el comprobante por WhatsApp para agilizar tu pedido.</p>
                    </div>
                `;
                break;
                
            case 'Nequi':
                content = `
                    <div class="payment-info">
                        <p><strong>Pago con Nequi</strong></p>
                        <p>Número: 3137593418</p>
                        <p>Nombre: Leidy Yohanna Montoya</p>
                        <p class="payment-note">Una vez realices el pago, envíanos la captura de pantalla por WhatsApp para agilizar tu pedido.</p>
                    </div>
                `;
                break;
                
            case 'Contra Entrega':
                content = `
                    <div class="payment-info">
                        <p><strong>Pago Contra Entrega</strong></p>
                        <p>Pagarás cuando recibas tu pedido.</p>
                        <p>Puedes pagar en efectivo o con tarjeta al momento de la entrega.</p>
                        <p class="payment-note">Este método tiene un recargo adicional de $5.000 por gastos de envío.</p>
                    </div>
                `;
                break;
        }
        
        container.innerHTML = content;
    }
    
    function enviarPedidoWhatsApp() {
        // Obtener carrito
        let carrito;
        try {
            carrito = JSON.parse(localStorage.getItem('carrito')) || { items: [], total: 0 };
        } catch (e) {
            console.error('Error al parsear carrito:', e);
            alert('Ocurrió un error al procesar el carrito');
            return;
        }
        
        // Verificar si hay productos en el carrito
        if (carrito.items.length === 0) {
            alert('No puedes finalizar una compra con el carrito vacío');
            return;
        }
        
        // Obtener datos del formulario
        const form = document.getElementById('checkout-form');
        
        if (!form) {
            alert('Error al procesar el formulario');
            return;
        }
        
        // Validar campos requeridos
        const camposRequeridos = [
            'nombres', 'apellidos', 'tipo_documento', 'num_documento',
            'fecha_nacimiento', 'ciudad', 'direccion', 'telefono_movil', 'email'
        ];
        
        let formularioValido = true;
        camposRequeridos.forEach(campo => {
            const input = document.getElementById(campo);
            if (!input.value.trim()) {
                input.classList.add('error');
                formularioValido = false;
            } else {
                input.classList.remove('error');
            }
        });
        
        if (!formularioValido) {
            alert('Por favor, completa todos los campos obligatorios');
            return;
        }
        
        // Obtener valores del formulario
        const nombres = document.getElementById('nombres').value;
        const apellidos = document.getElementById('apellidos').value;
        const tipoDocumento = document.getElementById('tipo_documento').value;
        const numDocumento = document.getElementById('num_documento').value;
        const fechaNacimiento = document.getElementById('fecha_nacimiento').value;
        const ciudad = document.getElementById('ciudad').value;
        const direccion = document.getElementById('direccion').value;
        const telefonoMovil = document.getElementById('telefono_movil').value;
        const email = document.getElementById('email').value;
        const metodoPago = document.querySelector('input[name="metodo_pago"]:checked').value;
        
        // Campos opcionales
        const sexo = document.getElementById('sexo')?.value || '';
        const estadoCivil = document.getElementById('estado_civil')?.value || '';
        const telefonoFijo = document.getElementById('telefono_fijo')?.value || '';
        
        // Crear mensaje de WhatsApp
        let mensaje = `*Nuevo Pedido*%0A%0A`;
        mensaje += `*Nombres:* ${nombres}%0A`;
        mensaje += `*Apellidos:* ${apellidos}%0A`;
        mensaje += `*Documento:* ${tipoDocumento} ${numDocumento}%0A`;
        mensaje += `*Fecha Nacimiento:* ${fechaNacimiento}%0A`;
        mensaje += `*Ciudad:* ${ciudad}%0A`;
        mensaje += `*Dirección:* ${direccion}%0A`;
        mensaje += `*Teléfono Móvil:* ${telefonoMovil}%0A`;
        mensaje += `*Email:* ${email}%0A`;
        
        if (telefonoFijo) {
            mensaje += `*Teléfono Fijo:* ${telefonoFijo}%0A`;
        }
        
        if (sexo) {
            mensaje += `*Sexo:* ${sexo}%0A`;
        }
        
        if (estadoCivil) {
            mensaje += `*Estado Civil:* ${estadoCivil}%0A`;
        }
        
        mensaje += `*Método de Pago:* ${metodoPago}%0A%0A`;
        mensaje += `*Productos:*%0A`;
        
        // Añadir productos al mensaje
        carrito.items.forEach(item => {
            const subtotal = item.precio * item.cantidad;
            mensaje += `- ${item.cantidad}x ${item.nombre} - $${formatNumber(subtotal)}%0A`;
        });
        
        mensaje += `%0A*Total:* $${formatNumber(carrito.total)}`;
        
        // Número de WhatsApp de la empresa
        const whatsappNumber = '573126421560';
        
        // Crear URL de WhatsApp y abrir en nueva ventana
        const whatsappUrl = `https://api.whatsapp.com/send?phone=${whatsappNumber}&text=${mensaje}`;
        window.open(whatsappUrl, '_blank');
        
        // Limpiar carrito después de enviar
        localStorage.removeItem('carrito');
        
        // Redirigir a la página de confirmación
        setTimeout(() => {
            window.location.href = '/pedidos/confirmacion';
        }, 1000);
    }
</script>

<style>
    .form-group input.error,
    .form-group select.error,
    .form-group textarea.error {
        border: 1px solid #e74c3c;
        background-color: #ffeaea;
    }
</style>